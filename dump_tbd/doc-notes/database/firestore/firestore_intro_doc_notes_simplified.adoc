=== Here's an explanation of how Firestore processes writes using **Spanner transactions** with a diagram:

---

## **Firestore Write Flow in Spanner (Restaurant Ratings Example)**

ğŸ“Œ **Scenario:**
A user adds a **new rating** to a restaurant. This involves:
- **Inserting a new rating document** (`/restaurants/one/ratings/2`)
- **Updating the restaurant's `numRatings` and `avgRatings` fields** (`/restaurants/one`)

This operation **must be atomic**, ensuring data consistency across Firestore and its Spanner-backed storage.

---

### **ğŸ“Œ Step-by-Step Flow of the Transaction**
### **1ï¸âƒ£ Firestore Backend Starts a Spanner Transaction**
- A **read-write transaction `T`** is created in **Spanner**.

### **2ï¸âƒ£ Read & Lock Affected Documents**
- Read `/restaurants/one` and `/restaurants/one/ratings/2` from **Spanner's Entities table**.
- **Exclusive locks** are acquired to prevent conflicting writes.
- Verify that:
  âœ… The restaurant **exists** (`/restaurants/one`).
  âœ… The new rating **does not exist yet** (`/restaurants/one/ratings/2`).

### **3ï¸âƒ£ Apply Firestore Security Rules**
- Firestore evaluates security rules for:
  - The **restaurant document** (`/restaurants/one`).
  - The **new rating document** (`/restaurants/one/ratings/2`).
- If the request passes security rules, proceed.

### **4ï¸âƒ£ Compute Index Entry Changes**
- **Old index entries for `numRatings` and `avgRatings` are removed**.
- **New index entries for updated `numRatings` and `avgRatings` are added**.
- **New index entries are created for the rating document (`/restaurants/one/ratings/2`)**.
- These changes are **batched into transaction `T`**.

### **5ï¸âƒ£ Prepare Two-Phase Commit with Real-time Cache**
- Choose **max commit timestamp `M`**.
- Send **Prepare RPCs** to Real-time Cache to synchronize **commit timestamps** (`mi`).

### **6ï¸âƒ£ Commit Transaction in Spanner**
- Spanner commits **all updates atomically**, ensuring:
  âœ… **Entities table updates** (restaurant & rating documents).
  âœ… **IndexEntries table updates** (index changes).
- **Additional exclusive locks** on IndexEntries rows prevent conflicts.
- Since **Spanner partitions data across tablets and servers**, this commit could involve multiple machines.

### **7ï¸âƒ£ Finalize Commit with Real-time Cache**
- Send **Accept RPCs** to Real-time Cache, ensuring it has:
  âœ… **Deleted documents**
  âœ… **Full copies of inserted documents**
  âœ… **Modified documents with changes**
- Real-time Cache tracks these updates **in memory** in **timestamp order** for real-time queries.

---

## **ğŸ“Œ Firestore Write Flow Diagram**

```plaintext
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Firestore Client (User) â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Firestore Backend       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Start Txn (T)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Read & Lock Docsâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Check Security  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Compute Index Changes â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Prepare Real-time Cache â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Commit Txn in Spanner â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Sync with Real-time Cache â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ğŸ”¥ Key Takeaways**
âœ” Firestore uses **Spanner transactions** to ensure consistency.
âœ” **Index updates happen within the same transaction**, ensuring atomicity.
âœ” **Real-time Cache** keeps track of changes for live queries.
âœ” **Two-phase commit** ensures Spanner and Real-time Cache stay in sync.

Would you like a more detailed breakdown of **Real-time Cache mechanics**? ğŸš€